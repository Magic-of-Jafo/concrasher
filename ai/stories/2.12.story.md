# Story 2.12: Implement Tabbed Convention Editor - Dealers Tab (User & Brand Linking)

**Status:** In-Progress

## Story

-   As an Organizer
-   I want to use the "Dealers" tab to list businesses or individuals who will be dealers at my convention, linking them from existing **User** or **Brand** profiles, and optionally overriding their display information for this specific event
-   so that I can accurately manage and display my list of vendors.

## Acceptance Criteria (ACs)

-   AC1: Organizer can search and link existing profiles (**User** and **Brand**) as dealers.
-   AC2: Organizer-defined overrides for dealer display info (name, description) are saved.
-   AC3: The list of dealers, including any overrides, is correctly saved and displayed in the tab.
-   AC4: The application logic correctly uses the existing data models (`ConventionDealerLink`, `Brand`).
-   AC5: The UI clearly indicates that linking `Talent` profiles is a feature planned for a future update.

## Tasks / Subtasks

-   [ ] **Prerequisite: Data Model & Database State**
    -   [x] **VERIFIED:** `prisma/schema.prisma` contains the `ProfileType` enum (`USER`, `BRAND`, `TALENT`).
    -   [x] **VERIFIED:** `prisma/schema.prisma` contains the `Brand` model.
    -   [x] **VERIFIED:** `prisma/schema.prisma` contains the `ConventionDealerLink` model with a generic `linkedProfileId`.
    -   [x] **USER ACTION:** Confirm database migrations are applied and the schema is in sync.
    -   [x] **USER ACTION:** Confirm Prisma Client is updated (`npx prisma generate`).

-   [ ] **Backend: Server Actions & Validation (AC: 1, 2, 3)**
    -   [x] In `src/lib/validators.ts`, create a Zod schema `DealerLinkSchema` for validating new and updated dealer links.
    -   [x] In `src/lib/actions.ts`, create/update a server action `searchProfiles(query, profileType)` that searches for `User` and `Brand` profiles.
    -   [x] In `src/lib/actions.ts`, create a server action `addDealerLink(conventionId, linkedProfileId, profileType, overrides)` to link a profile.
    -   [x] In `src/lib/actions.ts`, create a server action `updateDealerLink(dealerLinkId, overrides)` to update overrides.
    -   [x] In `src/lib/actions.ts`, create a server action `removeDealerLink(dealerLinkId)` to remove a dealer.

-   [ ] **Frontend: Component Development (AC: 1, 3, 5)**
    -   [x] Create `src/components/organizer/convention-editor/DealersTab.tsx`.
    -   [x] Create `src/components/organizer/convention-editor/DealerSearch.tsx`. The profile type selector should allow searching "User" and "Brand", and have a disabled/coming-soon option for "Talent".
    -   [x] Create `src/components/organizer/convention-editor/DealerListItem.tsx` to display linked dealers and controls.

-   [ ] **Frontend: Integration (AC: 1, 2, 3)**
    -   [x] In `DealersTab.tsx`, fetch and display the list of existing `ConventionDealerLink`s for the current convention.
    -   [x] Integrate `DealerSearch.tsx` and connect its results to the `addDealerLink` action.
    -   [x] Render the dealer list using `DealerListItem.tsx`.
    -   [x] Hook up the edit/remove controls in `DealerListItem.tsx` to the `updateDealerLink` and `removeDealerLink` server actions.
    -   [x] In `src/components/organizer/convention-editor/ConventionEditorTabs.tsx`, add the new `DealersTab`.

-   [ ] **Testing**
    -   [ ] Write unit tests for the `DealerLinkSchema`.
    -   [ ] Write integration tests for `DealersTab.tsx`, mocking server actions.
    -   [ ] Write E2E tests (Playwright) for the full user flow (searching, adding, editing, removing) for **User and Brand** dealers.
    -   [ ] Write unit tests for the new Zod schema.

## Dev Technical Guidance

**CRITICAL: The database schema is the source of truth.** This story has been updated to align with the existing schema. The implementation must follow the data models as they currently exist.

-   **Polymorphic Association:** The `ConventionDealerLink` model uses a "soft-link" or polymorphic association. The `profileType` field determines which table to query (`User` or `Brand`) using the `linkedProfileId`. Your backend logic (e.g., in a function that retrieves dealers with their full profile info) must handle this by checking the `profileType` and fetching data from the corresponding table.

-   **Out of Scope: `TalentProfile`:** The concept of a `TalentProfile` exists in the `ProfileType` enum but the model itself is **not implemented** and is out of scope for this story. All work should focus on `User` and `Brand` linking only. The UI should gracefully indicate that Talent linking is a future feature.

-   **Relevant `prisma/schema.prisma` Models:**

    ```prisma
    // This enum is already in the schema
    enum ProfileType {
      USER
      TALENT
      BRAND
    }

    // The Brand model to link to
    model Brand {
      id          String      @id @default(cuid())
      name        String      @unique
      // ... other fields
    }

    // The link table that connects a Convention to a dealer (User or Brand)
    model ConventionDealerLink {
      id                    String      @id @default(cuid())
      conventionId          String
      profileType           ProfileType // Determines which table linkedProfileId refers to
      linkedProfileId       String      // ID of the User or Brand
      displayNameOverride   String?
      descriptionOverride   String?
      order                 Int
      // ... other fields
      
      convention            Convention  @relation(fields: [conventionId], references: [id], onDelete: Cascade)

      @@unique([conventionId, profileType, linkedProfileId])
    }
    
    // Also note the existing relations on other models:
    
    // In model Convention:
    // dealerLinks         ConventionDealerLink[]
    ```

## Story Progress Notes

### Agent Model Used: `Gemini 2.5 Pro`

### Completion Notes List

-   Initial draft created based on `epic2.md`.
-   **Story revised to align with the current database schema, which is now the source of truth.**
-   **Scope is focused on linking `User` and `Brand` profiles only. `Talent` profile linking is deferred.**

### Change Log
-   First Draft
-   Revised story to align with production schema and un-deferred. Scope adjusted to User and Brand linking. 