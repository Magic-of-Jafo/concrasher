# Story 2.12: Implement Tabbed Convention Editor - Dealers Tab (NEW)

**Status:** Deferred

## Story

-   As an Organizer
-   I want to use the "Dealers" tab to list businesses or individuals who will be dealers at my convention, linking them from existing User, Talent, or Brand profiles, and optionally overriding their display information for this specific event
-   so that I can accurately manage and display my list of vendors.

## Acceptance Criteria (ACs)

-   AC1: Organizer can search and link existing profiles (User, Talent, Brand) as dealers.
-   AC2: Organizer-defined overrides for dealer display info (name, description) are saved.
-   AC3: The list of dealers, including any overrides, is correctly saved and displayed in the tab.
-   AC4: The underlying data models required for this feature (`TalentProfile`, `BrandProfile`, `ConventionDealerLink`) are successfully added to the database schema.

## Tasks / Subtasks

-   [ ] **Prerequisite: Data Model Implementation (AC: 4)**
    -   [x] In `prisma/schema.prisma`, define and add the new `ProfileType` enum.
    -   [ ] In `prisma/schema.prisma`, define and add the placeholder `TalentProfile` and `BrandProfile` models. These are prerequisites for linking and will be fully implemented in Epic 4.
    -   [ ] In `prisma/schema.prisma`, define and add the `ConventionDealerLink` model.
    -   [ ] Run `npx prisma migrate dev --name add_dealer_models` to apply the schema changes to the database.
    -   [ ] Run `npx prisma generate` to update the Prisma Client.
-   [ ] **Backend: Server Actions & Validation (AC: 1, 2, 3)**
    -   [ ] In `src/lib/validators.ts`, create a Zod schema `DealerLinkSchema` for validating new and updated dealer links, including the override fields.
    -   [ ] In `src/lib/actions.ts`, create a server action `searchProfiles(query, profileType)` that can search for Users, Talent, or Brands based on the provided type.
    -   [ ] In `src/lib/actions.ts`, create a server action `addDealerLink(conventionId, profileId, profileType, overrides)` to link a profile as a dealer.
    -   [ ] In `src/lib/actions.ts`, create a server action `updateDealerLink(dealerLinkId, overrides)` to update the display name and description overrides.
    -   [ ] In `src/lib/actions.ts`, create a server action `removeDealerLink(dealerLinkId)` to remove a dealer from a convention.
-   [ ] **Frontend: Component Development (AC: 1, 3)**
    -   [ ] Create `src/components/organizer/convention-editor/DealersTab.tsx`. This will be the main container for the feature.
    -   [ ] Create `src/components/organizer/convention-editor/DealerSearch.tsx`. This component should contain a search input and a mechanism (e.g., tabs or a dropdown) to select the profile type to search (User, Talent, Brand). It should use the `searchProfiles` action and display results.
    -   [ ] Create `src/components/organizer/convention-editor/DealerListItem.tsx`. This component will display a linked dealer, show their original name and overridden name/description, and contain controls to edit overrides or remove the dealer link.
-   [ ] **Frontend: Integration (AC: 1, 2, 3)**
    -   [ ] In `DealersTab.tsx`, fetch and display the list of existing `ConventionDealerLink`s for the current convention.
    -   [ ] Integrate `DealerSearch.tsx` into the tab. When a profile is selected from search results, it should call the `addDealerLink` action and update the list.
    -   [ ] Render the list of dealers using the `DealerListItem.tsx` component.
    -   [ ] Hook up the edit/remove controls in `DealerListItem.tsx` to the `updateDealerLink` and `removeDealerLink` server actions.
    -   [ ] In `src/components/organizer/convention-editor/ConventionEditorTabs.tsx`, add the new `DealersTab` to the list of tabs for the convention editor.
-   [ ] **Testing**
    -   [ ] Write unit tests for the new Zod schema.
    -   [ ] Write integration tests for the `DealersTab.tsx` component, mocking the server actions to verify UI behavior.
    -   [ ] Write E2E tests (Playwright) to simulate the full user flow: searching for different profile types, adding them as dealers, setting overrides, editing, and removing them.

## Dev Technical Guidance

This story requires adding new data models before any other work can begin.

-   **CRITICAL: `prisma/schema.prisma` additions:**
    The following models are missing and must be added. The `TalentProfile` and `BrandProfile` are simple placeholders to make linking possible; they will be expanded in Epic 4.

    ```prisma
    // Add this enum
    enum ProfileType {
      USER
      TALENT
      BRAND
    }

    // Add this placeholder model
    model TalentProfile {
      id          String @id @default(cuid())
      userId      String @unique
      displayName String
      user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

      // Relation to dealer links
      conventionsAsDealer ConventionDealerLink[] @relation("LinkedTalentProfile")
    }

    // Add this placeholder model
    model BrandProfile {
      id          String @id @default(cuid())
      brandName   String @unique
      // Other fields to be added in Epic 4

      // Relation to dealer links
      conventionsAsDealer ConventionDealerLink[] @relation("LinkedBrandProfile")
    }

    // Add the main model for this story
    model ConventionDealerLink {
      id                      String      @id @default(cuid())
      conventionId            String
      profileType             ProfileType
      
      // Links to one of the possible profiles
      userId                  String?
      talentProfileId         String?
      brandProfileId          String?

      // Optional Overrides
      displayNameOverride     String?
      descriptionOverride     String?
      
      order                   Int?

      convention              Convention      @relation(fields: [conventionId], references: [id], onDelete: Cascade)
      user                    User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
      talentProfile           TalentProfile?  @relation("LinkedTalentProfile", fields: [talentProfileId], references: [id], onDelete: Cascade)
      brandProfile            BrandProfile?   @relation("LinkedBrandProfile", fields: [brandProfileId], references: [id], onDelete: Cascade)

      @@unique([conventionId, userId, talentProfileId, brandProfileId])
    }
    
    // Also, add the new relations to the User and Convention models:
    
    // In model User:
    // talentProfile       TalentProfile?
    // conventionsAsDealer ConventionDealerLink[]
    
    // In model Convention:
    // dealers             ConventionDealerLink[]

    ```

-   **File Locations:**
    -   **New Components:** `src/components/organizer/convention-editor/`
    -   **Server Logic:** `src/lib/actions.ts`
    -   **Validation:** `src/lib/validators.ts`

-   **UI/UX:**
    -   Use Material UI (MUI) components for consistency.
    -   The search functionality should be clear, allowing the user to switch between searching for Users, Talent, and Brands.
    -   The list of added dealers should clearly distinguish between the original profile name and the overridden display name.

## Story Progress Notes

### Agent Model Used: `Gemini 2.5 Pro`

### Completion Notes List

-   Initial draft created based on `epic2.md` and analysis of existing project structure and schema.
-   Story deferred by user request. Functionality is not required for MVP. All tasks are on hold.

### Change Log
- First Draft
- Status changed to Deferred. 