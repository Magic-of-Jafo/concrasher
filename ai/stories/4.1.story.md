# Story 4.1: Talent Profile - Data Model & Basic CRUD API

## Status: Draft

## Story

-   **Technical Story:** To ensure the `TalentProfile` data model in Prisma (as defined in `docs/data-models.md` and Epic 4) is correctly implemented, including fields for skills, biography, past conventions link, contact information, and profile picture URL. Implement basic API endpoints (or Server Actions) for CRUD operations on these profiles.

## Acceptance Criteria (ACs)

1.  The Prisma schema for `TalentProfile` (and its relation to `User` and the `ConventionTalent` join table) is correctly defined as per `docs/data-models.md` and Epic 4, and migrations apply successfully.
2.  A user whose `User.roles` includes `TALENT` can successfully create their `TalentProfile` (linked to their `User.id`) via an API Route or Server Action, with data persisted by Prisma. Only one profile per user is allowed (enforced by `TalentProfile.userId @unique`).
3.  The owner of a `TalentProfile` (where `TalentProfile.userId === session.user.id`) or an `ADMIN` user can update it via an API Route or Server Action, with changes persisted by Prisma.
4.  `TalentProfile` data (single by `userId` and list for public view) can be retrieved via API, with data fetched by Prisma.
5.  An attempt to create a `TalentProfile` by a user without the `TALENT` role, or an attempt to create a second profile by a user who already has one, is rejected.

## Tasks / Subtasks

-   [x] **Task 1 (AC: 1):** Add the new `TalentProfile` and `ConventionTalent` models to `prisma/schema.prisma`.
    -   [x] **Subtask 1.1:** Define the `TalentProfile` model with all fields specified in the "Dev Technical Guidance" section below. Ensure the `userId` field is unique to enforce a one-to-one relationship with the `User` model.
    -   [x] **Subtask 1.2:** Add the `talentProfile` relation to the `User` model: `talentProfile TalentProfile?`.
    -   [x] **Subtask 1.3:** Define the `ConventionTalent` join model to create a many-to-many relationship between `Convention` and `TalentProfile`.
    -   [x] **Subtask 1.4:** Add the `talent` relation to the `Convention` model: `talent ConventionTalent[]`.
-   [x] **Task 2 (AC: 1):** Create a new Prisma migration for the schema changes.
    -   `npx prisma migrate dev --name add_talent_profile_model`
-   [x] **Task 3 (AC: 1):** Apply and verify the migration against the development database.
-   [x] **Task 4 (AC: 2, 3, 4, 5):** Implement the API Routes or Server Actions for `TalentProfile` CRUD operations.
    -   [x] **Subtask 4.1:** Create a `POST` endpoint (e.g., `/api/talent-profiles`) to create a profile. Enforce authorization: user must have `TALENT` role and not already have a profile.
    -   [x] **Subtask 4.2:** Create a `GET` endpoint (e.g., `/api/talent-profiles/[userId]`) to fetch a single profile.
    -   [x] **Subtask 4.3:** Create a `PUT` endpoint (e.g., `/api/talent-profiles/[userId]`) to update a profile. Enforce authorization: user must be the profile owner or an `ADMIN`.
    -   [x] **Subtask 4.4:** Create a `GET` endpoint (e.g., `/api/talent-profiles`) for a public, paginated list of all talent profiles.

## Dev Technical Guidance

The `TalentProfile` and `ConventionTalent` models do not currently exist in `prisma/schema.prisma`. They must be added. The following definitions are based on the requirements in Epic 4.

**Add to `prisma/schema.prisma`:**

```prisma
// --- Talent Profile & Related Models ---
model TalentProfile {
  id                String    @id @default(cuid())
  userId            String    @unique // 1:1 with User
  displayName       String
  tagline           String?
  bio               String?   @db.Text
  profilePictureUrl String?
  websiteUrl        String?
  contactEmail      String?
  skills            String[]  @default([])

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  conventions       ConventionTalent[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model ConventionTalent {
  id              String        @id @default(cuid())
  conventionId    String
  talentProfileId String

  convention      Convention    @relation(fields: [conventionId], references: [id], onDelete: Cascade)
  talentProfile   TalentProfile @relation(fields: [talentProfileId], references: [id], onDelete: Cascade)

  assignedAt      DateTime      @default(now())
  
  @@unique([conventionId, talentProfileId])
  @@index([conventionId])
  @@index([talentProfileId])
}
```

**Modify the `User` model in `prisma/schema.prisma`:**

```prisma
// ... existing User model fields
  talentProfile    TalentProfile?
  sessions         Session[]
}
```

**Modify the `Convention` model in `prisma/schema.prisma`:**

```prisma
// ... existing Convention model fields
  talent                   ConventionTalent[]
  venues                   Venue[]
  settings                 ConventionSetting[]
}
```

## Story Progress Notes

### Agent Model Used: `<Agent Model Name/Version>`

### Completion Notes List

{Any notes about implementation choices, difficulties, or follow-up needed}

### Change Log 