# Story 2.13: Implement Tabbed Convention Editor - Media Tab (NEW)

**Status:** In-Progress

## Story

-   As an Organizer
-   I want to use the "Media" tab to upload multiple promotional images and add links to YouTube/Vimeo videos for my convention
-   so I can enhance its public listing with visual content.

## Acceptance Criteria (ACs)

-   AC1: Organizer can upload multiple promotional images, each with an optional caption.
-   AC2: Uploaded images are correctly associated with the convention and displayed in the Media tab.
-   AC3: Organizer can reorder the uploaded promotional images.
-   AC4: Organizer can add multiple YouTube or Vimeo links, each with an optional caption.
-   AC5: Added video links are correctly associated with the convention and displayed in the Media tab.
-   AC6: The tab correctly uses the existing `ImageUploader` component for handling image uploads.
-   AC7: All media information (image URLs, captions, order, video links) is correctly saved to the database.
-   AC8: The primary Cover and Profile images for the convention (from the "Basic Info" tab) are also managed via this tab's logic, consolidating image management.

## Tasks / Subtasks

-   [ ] **Backend: Data Model & API**
    -   [ ] In `prisma/schema.prisma`, define the `ConventionMedia` model to store image URLs, video links, captions, and an order field.
    -   [ ] Add a one-to-many relation from `Convention` to `ConventionMedia`.
    -   [ ] Run `npx prisma migrate` (or follow project-specific migration protocol) to apply schema changes.
    -   [ ] In `src/lib/actions.ts`, create a server action `updateConventionMedia(conventionId, mediaData)` that takes an array of media objects and updates the database (deleting old, updating existing, adding new).
    -   [ ] In `src/lib/actions.ts`, ensure the `upload` server action (used by `ImageUploader`) is robust and returns the URL of the uploaded file.

-   [ ] **Frontend: Component Development**
    -   [ ] Create `src/components/organizer/convention-editor/MediaTab.tsx`. This will be the main container for the feature.
    -   [ ] In `MediaTab.tsx`, create sections for "Cover & Profile Images" and "Promotional Gallery".
    -   [ ] In the "Cover & Profile Images" section, use the existing `ImageUploader` component twice, for the `coverImageUrl` and `profileImageUrl` fields on the `Convention` model.
    -   [ ] In the "Promotional Gallery" section, create a component `PromotionalImageItem.tsx` that displays an uploaded image, its caption input, and drag handles for reordering.
    -   [ ] Create a component `VideoLinkItem.tsx` that displays a video embed preview (or a placeholder), its caption input, and a remove button.

-   [ ] **Frontend: Integration**
    -   [ ] In `MediaTab.tsx`, fetch the existing `ConventionMedia` records for the convention.
    -   [ ] Implement drag-and-drop reordering for the list of promotional images.
    -   [ ] Implement logic to add/remove video link items dynamically.
    -   [ ] On "Save", call the `updateConventionMedia` server action with the full, ordered list of media items.
    -   [ ] In `src/components/organizer/convention-editor/ConventionEditorTabs.tsx`, add the new `MediaTab` to the list of tabs.

-   [ ] **Testing**
    -   [ ] Write unit tests for the `updateConventionMedia` server action logic.
    -   [ ] Write integration tests for the `MediaTab.tsx` component, mocking server actions to verify UI behavior (image display, reordering, adding/removing videos).
    -   [ ] Write E2E tests (Playwright) to simulate the full user flow: uploading images, adding video links, reordering, saving, and verifying the media is displayed correctly on the public convention page (as part of Story 2.15).

## Dev Technical Guidance

-   **Data Model:** A new `ConventionMedia` table is required.
    ```prisma
    model ConventionMedia {
      id           String   @id @default(cuid())
      conventionId String
      type         String   // "IMAGE" or "VIDEO"
      url          String
      caption      String?
      order        Int
      createdAt    DateTime @default(now())
      updatedAt    DateTime @updatedAt
      convention   Convention @relation(fields: [conventionId], references: [id], onDelete: Cascade)
    }

    // In model Convention, add:
    // media        ConventionMedia[]
    ```
-   **Image Uploads:** Leverage the existing `ImageUploader.tsx` and its associated server actions/API for handling the file uploads to object storage. The key task for this story is managing the URLs and metadata *after* the upload is complete.
-   **UI/UX:**
    -   For reordering, use a library like `@hello-pangea/dnd`.
    -   Display a preview or thumbnail for uploaded images and video links.
    -   Ensure the interface for adding/removing/reordering media is intuitive.

## Story Progress Notes

### Agent Model Used: `Gemini 2.5 Pro`

### Completion Notes List

-   Initial draft created based on `epic2.md`.

### Change Log
-   First Draft 